name: Workflow
on:
  push:
    branches:
      - feature/*

jobs:
  SAST:
      runs-on: ubuntu-latest
      steps:
        - name: Checkout del cÃ³digo
          uses: actions/checkout@v4
          with:
            fetch-depth: 0  

        - name: Validando existencia de proyecto en SonarCloud
          id: validateProjectOnSonar
          env:
            SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          run: |
            set +e
            curl -f -X POST -u "${SONAR_TOKEN}:" 'https://sonarcloud.io/api/projects/create' \
              -d 'name=${{ github.event.repository.name }}' \
              -d 'project=${{ github.event.repository.name }}' \
              -d 'organization=nixett-devsecops-laboratorio' \
              -d 'visibility=public'
            
            if [ $? -ne 0 ]; then
              echo "Proyecto ya existe en Sonarcloud"
              echo "proyectoExiste=1" >> $GITHUB_OUTPUT
            else
              echo "Proyecto ${{ github.event.repository.name }} creado exitosamente en Sonarcloud"
              echo "Se establece rama main como rama por defecto"
              curl -X POST -u "${SONAR_TOKEN}:" 'https://sonarcloud.io/api/project_branches/rename' \
                -d 'name=main' \
                -d 'project=${{ github.event.repository.name }}'
            fi
            set -e

        - name: Set up JDK 17
          uses: actions/setup-java@v4
          with:
            java-version: '17'
            distribution: 'temurin'

        - name: SonarCloud Scan
          uses: sonarsource/sonarcloud-github-action@master
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          with:
            args: >
              -Dsonar.organization=nixett-devsecops-laboratorio
              -Dsonar.projectKey=${{ github.event.repository.name }}
              -Dsonar.sources=.
              -Dsonar.host.url=https://sonarcloud.io