name: Workflow
on:
  push:
    branches:
      - main
      - feature/*

jobs:
  # SAST:
  #     runs-on: ubuntu-latest
  #     steps:
  #       - name: Checkout del código
  #         uses: actions/checkout@v4
  #         with:
  #           fetch-depth: 0  

  #       - name: Validando existencia de proyecto en SonarCloud
  #         id: validateProjectOnSonar
  #         env:
  #           SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
  #           PROJECT_NAME: ${{ github.event.repository.name }}
  #           ORG_KEY: nixett-devsecops-laboratorio
  #         run: |
  #           set +e
  #           echo "Validando si el proyecto '$PROJECT_NAME' existe en la organización '$ORG_KEY'..."
            
  #           RESPONSE=$(curl -s -u "${SONAR_TOKEN}:" "https://sonarcloud.io/api/projects/search?organization=$ORG_KEY&q=$PROJECT_NAME")
            
  #           echo "Respuesta de SonarCloud:"
  #           echo "$RESPONSE"
            
  #           PROJECT_KEY="${ORG_KEY}_${PROJECT_NAME}"
  #           echo "Buscando projectKey esperado: $PROJECT_KEY"
            
  #           EXISTE=$(echo "$RESPONSE" | grep -o "\"key\":\"$PROJECT_KEY\"")
            
  #           if [ -n "$EXISTE" ]; then
  #             echo "Proyecto ya existe en SonarCloud"
  #             echo "proyectoExiste=1" >> $GITHUB_OUTPUT
  #           else
  #             echo "Proyecto no encontrado, creando en SonarCloud..."
  #             CREATE_RESPONSE=$(curl -s -X POST -u "${SONAR_TOKEN}:" 'https://sonarcloud.io/api/projects/create' \
  #               -d "organization=$ORG_KEY" \
  #               -d "project=$PROJECT_KEY" \
  #               -d "name=$PROJECT_NAME" \
  #               -d "visibility=public")

  #             echo "Respuesta de creación: $CREATE_RESPONSE"

  #             if echo "$CREATE_RESPONSE" | grep -q "\"key\":\"$PROJECT_KEY\""; then
  #               echo "Proyecto '$PROJECT_NAME' creado exitosamente."
  #               echo "proyectoExiste=0" >> $GITHUB_OUTPUT
  #             else
  #               echo "Error al crear el proyecto en SonarCloud. Respuesta completa:"
  #               echo "$CREATE_RESPONSE"
  #               exit 0
  #             fi
  #           fi


  #       - name: Set up JDK 17
  #         uses: actions/setup-java@v4
  #         with:
  #           java-version: '17'
  #           distribution: 'temurin'

  #       - name: SonarCloud Scan
  #         uses: sonarsource/sonarcloud-github-action@v2
  #         env:
  #           GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  #           SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
  #         with:
  #           args: >
  #             -Dsonar.organization=nixett-devsecops-laboratorio
  #             -Dsonar.projectKey=nixett-devsecops-laboratorio_devsecops-laboratorio
  #             -Dsonar.sources=src,functions
  #             -Dsonar.exclusions=**/*.test.ts,**/*.test.tsx,**/*.spec.ts
  #             -Dsonar.typescript.tsconfigPath=tsconfig.json
  #             -Dsonar.host.url=https://sonarcloud.io
  #             -Dsonar.branch.name=${{ github.ref_name }}
  #             -X

  #       - name: Mostrar archivos en src
  #         run: |
  #           echo "=== Archivos en src ==="
  #           ls -R src

  #       - name: Validando vulnerabilidades y hotspots en SonarCloud
  #         env:
  #           SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
  #           PROJECT_KEY: nixett-devsecops-laboratorio_devsecops-laboratorio
  #           BRANCH: ${{ github.ref_name }}
  #         run: |
  #           echo "Validando vulnerabilidades y hotspots en SonarCloud para $PROJECT_KEY ($BRANCH)..."

  #           RESPONSE_VULN=$(curl -s -u "${SONAR_TOKEN}:" \
  #             "https://sonarcloud.io/api/issues/search?branch=${BRANCH}&componentKeys=${PROJECT_KEY}&types=VULNERABILITY")
  #           TOTAL_VULN=$(echo "$RESPONSE_VULN" | jq '.total // 0')

  #           RESPONSE_HOTSPOT=$(curl -s -u "${SONAR_TOKEN}:" \
  #             "https://sonarcloud.io/api/hotspots/search?projectKey=${PROJECT_KEY}&branch=${BRANCH}")
  #           TOTAL_HOTSPOT=$(echo "$RESPONSE_HOTSPOT" | jq '.paging.total // 0')

  #           echo "Vulnerabilidades detectadas: $TOTAL_VULN"
  #           echo "Hotspots detectados: $TOTAL_HOTSPOT"

  #           TOTAL=$((TOTAL_VULN + TOTAL_HOTSPOT))
  #           echo "Total combinado: $TOTAL"

  #           if [ "$TOTAL" -gt 0 ]; then
  #             echo "Se detectaron vulnerabilidades o hotspots de seguridad en SonarCloud."
  #             # exit 1
  #           else
  #             echo "No se encontraron vulnerabilidades ni hotspots críticos."
  #           fi

  SCA:
    # needs: SAST
    runs-on: ubuntu-latest
    steps:
      - name: Checkout del código
        uses: actions/checkout@v4

      - name: Instalar dependencias requeridas
        run: |
          sudo apt-get update
          sudo apt-get install -y jq unzip wget

      - name: Instalar OWASP Dependency-Check CLI (v10.0.4)
        run: |
          echo "Instalando OWASP Dependency-Check 10.0.4..."
          wget https://github.com/jeremylong/DependencyCheck/releases/download/v10.0.4/dependency-check-10.0.4-release.zip
          unzip dependency-check-10.0.4-release.zip -d dependency-check
          chmod +x dependency-check/dependency-check/bin/dependency-check.sh

      - name: Cachear base de datos Dependency-Check
        uses: actions/cache@v4
        with:
          path: ~/.dependency-check
          key: dependency-check-db-v10

      - name: Ejecutar Dependency-Check
        run: |
          mkdir -p reports

          ./dependency-check/dependency-check/bin/dependency-check.sh \
            --project "${{ github.event.repository.name }}" \
            --scan "." \
            --format "ALL" \
            --out "reports" \
            --enableRetired \
            --disableNvd \
            --failOnCVSS 4

      - name: Analizar vulnerabilidades detectadas (CVSS >= 4)
        run: |
          REPORT_JSON="reports/dependency-check-report.json"

          if [ ! -f "$REPORT_JSON" ]; then
            echo "No se encontró el reporte JSON en $REPORT_JSON"
            echo "Archivos disponibles:"
            ls -l reports || true
            exit 1
          fi

          COUNT=$(jq '[.dependencies[].vulnerabilities[]? | select(.cvssScore >= 4)] | length' "$REPORT_JSON")
          echo "Vulnerabilidades con CVSS >= 4 detectadas: $COUNT"

          if [ "$COUNT" -gt 0 ]; then
            echo "Se encontraron vulnerabilidades medias, altas o críticas. Quebrando el pipeline."
            exit 1
          else
            echo "No se encontraron vulnerabilidades medias, altas o críticas."
          fi

      - name: Subir reportes como artefacto
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: DependencyCheck-Reports
          path: reports